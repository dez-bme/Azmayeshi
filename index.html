// Google Apps Script (Code.gs)

function doGet(e) {
  if (e.parameter.action === 'searchAuthors') {
    return searchAuthors(e);
  } else if (e.parameter.action === 'getArticles') {
    return getArticles(e);
  } else {
    return HtmlService.createHtmlOutputFromFile('index')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  }
}

function searchAuthors(e) {
  try {
    const searchTerm = e.parameter.searchTerm.toLowerCase();
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const authors = [];

    for (let i = 1; i < data.length; i++) { // Start from 1 to skip headers
      if (data[i][0].toLowerCase().includes(searchTerm)) { // Author column (0)
        authors.push(data[i][0]);
      }
    }

    // Remove duplicates
    const uniqueAuthors = [...new Set(authors)];

    return ContentService.createTextOutput(JSON.stringify(uniqueAuthors))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  }
}

function getArticles(e) {
  try {
    const authorName = e.parameter.authorName;
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const articles = [];

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === authorName) {
        articles.push({
          title: data[i][1], // Article title (1)
          uploadDate: data[i][4], // Upload date (4)
          downloadLink: data[i][3] // Download link (3)
        });
      }
    }

    return ContentService.createTextOutput(JSON.stringify(articles))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  }
}
